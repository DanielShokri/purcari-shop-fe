---
description: Redux Toolkit and RTK Query patterns
globs:
  - "store/**/*.ts"
  - "services/**/*.ts"
---

# Redux & RTK Query Patterns

## Store Configuration
```typescript
// store/index.ts
import { configureStore } from '@reduxjs/toolkit';
import { setupListeners } from '@reduxjs/toolkit/query';
import { api } from '../services/api/baseApi';
import cartReducer from './slices/cartSlice';
import uiReducer from './slices/uiSlice';

export const store = configureStore({
  reducer: {
    [api.reducerPath]: api.reducer,
    cart: cartReducer,
    ui: uiReducer,
  },
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware().concat(api.middleware),
});

setupListeners(store.dispatch);

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

## Typed Hooks
```typescript
// store/hooks.ts
import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux';
import type { RootState, AppDispatch } from './index';

export const useAppDispatch = () => useDispatch<AppDispatch>();
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;
```

## Slice Pattern
```typescript
// store/slices/exampleSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { RootState } from '../index';

interface ExampleState {
  value: string;
  items: Item[];
}

const initialState: ExampleState = {
  value: '',
  items: [],
};

const exampleSlice = createSlice({
  name: 'example',
  initialState,
  reducers: {
    setValue: (state, action: PayloadAction<string>) => {
      state.value = action.payload;
    },
    addItem: (state, action: PayloadAction<Item>) => {
      state.items.push(action.payload);
    },
  },
});

// Export actions
export const { setValue, addItem } = exampleSlice.actions;

// Export selectors
export const selectValue = (state: RootState) => state.example.value;
export const selectItems = (state: RootState) => state.example.items;

// Export reducer
export default exampleSlice.reducer;
```

## RTK Query Base API
```typescript
// services/api/baseApi.ts
import { createApi, fakeBaseQuery } from '@reduxjs/toolkit/query/react';

export const api = createApi({
  reducerPath: 'api',
  baseQuery: fakeBaseQuery(), // Replace with fetchBaseQuery for real API
  tagTypes: ['Products', 'Categories', 'Orders', 'User'],
  endpoints: () => ({}),
});
```

## RTK Query Endpoints
```typescript
// services/api/productsApi.ts
import { api } from './baseApi';
import { Product } from '../../types';

export const productsApi = api.injectEndpoints({
  endpoints: (builder) => ({
    getProducts: builder.query<Product[], void>({
      queryFn: async () => {
        // API call logic
        return { data: products };
      },
      providesTags: ['Products'],
    }),
    getProductById: builder.query<Product, string>({
      queryFn: async (id) => {
        const product = await fetchProduct(id);
        if (!product) {
          return { error: { status: 404, statusText: 'Not Found', data: null } };
        }
        return { data: product };
      },
    }),
  }),
});

// Export hooks
export const {
  useGetProductsQuery,
  useGetProductByIdQuery,
} = productsApi;
```

## Using RTK Query in Components
```typescript
const { data: products, isLoading, error } = useGetProductsQuery();
const { data: product, isLoading } = useGetProductByIdQuery(id || '');

// With skip
const { data } = useGetProductByIdQuery(id || '', { skip: !id });
```

## Selectors using API State
```typescript
// Access API cache data within a selector
import { apiSlice } from '../services/api/someApi';

export const selectComputedData = (state: RootState) => {
  // Select data from API slice
  const result = apiSlice.endpoints.getSomeData.select()(state);
  const data = result.data || [];
  
  // Combine with local state to derive new values
  return computeSomething(state.localSlice.items, data);
};
```

## Cart Slice with localStorage
```typescript
// Pattern for persisted state
const cartSlice = createSlice({
  name: 'cart',
  initialState: { items: [], isInitialized: false },
  reducers: {
    initializeCart: (state) => {
      const saved = localStorage.getItem('cart');
      if (saved) state.items = JSON.parse(saved);
      state.isInitialized = true;
    },
    addToCart: (state, action) => {
      // Update state
      state.items.push(action.payload);
      // Persist
      localStorage.setItem('cart', JSON.stringify(state.items));
    },
  },
});
```

## Dispatching Actions
```typescript
// In components
const dispatch = useAppDispatch();

dispatch(addToCart({
  id: product.$id,
  title: product.productNameHe,
  price: product.price,
  quantity: 1,
  imgSrc: product.images[0]
}));

dispatch(toggleCartModal());
dispatch(updateQuantity({ id: item.id, quantity: item.quantity + 1 }));
```
