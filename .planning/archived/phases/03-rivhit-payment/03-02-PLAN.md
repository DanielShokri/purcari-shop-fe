---
phase: 03-rivhit-payment
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/storefront/components/checkout/PaymentStep.tsx
  - apps/storefront/pages/CheckoutPage.tsx
  - apps/storefront/pages/OrderConfirmationPage.tsx
  - apps/storefront/schemas/validationSchemas.ts
autonomous: false
must_haves:
  truths:
    - "Checkout payment step redirects to Rivhit hosted payment page instead of showing mock card inputs"
    - "User is redirected back to order confirmation after completing payment on Rivhit"
    - "Order confirmation page shows payment status from paymentTransactions table"
    - "Payment step shows loading state while generating Rivhit payment URL"
    - "Errors from Rivhit API are displayed to the user with retry option"
  artifacts:
    - path: "apps/storefront/components/checkout/PaymentStep.tsx"
      provides: "Rivhit payment redirect UI replacing mock card form"
      min_lines: 40
    - path: "apps/storefront/pages/CheckoutPage.tsx"
      provides: "Updated checkout flow that creates order first, then redirects to Rivhit"
      contains: "createPaymentPage"
    - path: "apps/storefront/pages/OrderConfirmationPage.tsx"
      provides: "Payment status display from paymentTransactions"
      contains: "getPaymentByOrderId"
  key_links:
    - from: "apps/storefront/pages/CheckoutPage.tsx"
      to: "convex/rivhit.ts"
      via: "useAction(api.rivhit.createPaymentPage)"
      pattern: "createPaymentPage"
    - from: "apps/storefront/pages/OrderConfirmationPage.tsx"
      to: "convex/rivhit.ts"
      via: "useQuery(api.rivhit.getPaymentByOrderId)"
      pattern: "getPaymentByOrderId"
---

<objective>
Replace the mock payment UI with Rivhit hosted payment page integration and update the checkout flow to create the order first, then redirect to Rivhit for secure payment collection.

Purpose: Enable real credit card payments via Rivhit's hosted page (PCI-compliant — we never touch card data). The user completes shipping info, reviews their order, then is redirected to Rivhit's secure page to pay. After payment, they return to the order confirmation page.

Output: Updated checkout flow: Shipping → Review → Pay via Rivhit redirect → Order Confirmation with payment status.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-rivhit-payment/03-01-SUMMARY.md
@apps/storefront/pages/CheckoutPage.tsx
@apps/storefront/components/checkout/PaymentStep.tsx
@apps/storefront/components/checkout/ReviewStep.tsx
@apps/storefront/pages/OrderConfirmationPage.tsx
@apps/storefront/schemas/validationSchemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor checkout flow — order first, then Rivhit payment redirect</name>
  <files>
    apps/storefront/pages/CheckoutPage.tsx
    apps/storefront/components/checkout/PaymentStep.tsx
    apps/storefront/schemas/validationSchemas.ts
  </files>
  <action>
**The checkout flow changes from 3 steps to 2 steps + redirect:**

Old flow: Shipping → Payment (mock card inputs) → Review → Create Order
New flow: Shipping → Review → Create Order → Redirect to Rivhit Payment Page → Return to Confirmation

**1. Update `validationSchemas.ts`:**
- Remove the `paymentSchema` section (cardNumber, expiryDate, cvv fields) from the checkout schema
- Keep only shipping fields in the checkout form validation
- The `checkoutSchema` should only validate: firstName (or fullName), email, phone, street, city, postalCode

**2. Rewrite `PaymentStep.tsx` as `RivhitPaymentRedirect`:**
- Remove ALL mock card input fields (cardNumber, expiryDate, cvv)
- Replace with a component that:
  - Shows order summary (total amount in ILS)
  - Shows a "Proceed to Secure Payment" button (styled prominently)
  - Shows Rivhit/credit card logos for trust
  - Has loading state: "Preparing secure payment..." with spinner while the Rivhit URL is being generated
  - Has error state: Shows error message + "Try Again" button
  - On button click: calls the parent's `onProceedToPayment()` callback
  - Shows a note in Hebrew: "תועבר/י לדף תשלום מאובטח של רבחית" (You will be redirected to Rivhit's secure payment page)
- This component does NOT make the API call itself — the parent CheckoutPage orchestrates

**3. Update `CheckoutPage.tsx`:**
- Change step flow from 3 steps to 2 steps: Shipping → Review+Pay
- Import `useAction` from "convex/react" for calling the Rivhit action
- Add `const createPaymentPage = useAction(api.rivhit.createPaymentPage)`
- Remove card-related form fields from react-hook-form setup
- Update the form submit handler:
  ```
  1. Validate shipping form
  2. Create the order in Convex (same as before, but with payment: { method: 'Rivhit', transactionId: 'pending', chargeDate: new Date().toISOString() })
  3. Call createPaymentPage({ orderId }) to get the Rivhit payment URL
  4. If success: window.location.href = paymentUrl (full redirect to Rivhit hosted page)
  5. If error: Show error in PaymentStep component, don't redirect
  ```
- Add state management:
  - `isProcessingPayment: boolean` — while creating order + getting Rivhit URL
  - `paymentError: string | null` — if Rivhit API fails
- The "Review" step now includes the "Proceed to Payment" button
- Remove the old Step 2 (Payment) from the stepper — now it's just Step 1: Shipping, Step 2: Review & Pay
- Update `CheckoutProgressBar` steps if it's configured here

**Important architectural note:** The order is created BEFORE payment (with status 'pending'). This is the standard e-commerce pattern — create order, attempt payment, update order status based on payment result. The IPN webhook (from Plan 01) handles updating the order status when payment completes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes (no TypeScript errors from removed card fields)
2. Open storefront at localhost:3000, add items to cart, go to checkout
3. Verify only 2 steps shown: Shipping and Review & Pay
4. Verify no card number/CVV/expiry inputs anywhere
5. Verify "Proceed to Secure Payment" button appears on review step
  </verify>
  <done>
Checkout is 2 steps (Shipping → Review & Pay). No mock card inputs. "Proceed to Secure Payment" button triggers order creation + Rivhit redirect. Order created with 'pending' status before payment attempt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OrderConfirmationPage to show Rivhit payment status</name>
  <files>
    apps/storefront/pages/OrderConfirmationPage.tsx
  </files>
  <action>
Update `OrderConfirmationPage.tsx` to:

1. Import and use `useQuery(api.rivhit.getPaymentByOrderId, { orderId })` to get payment status
2. Show payment status section:
   - `pending`: "Payment is being processed..." with a subtle loading animation. This is the state when the user has been redirected back but the IPN hasn't arrived yet. Use Convex's reactive queries — the page will automatically update when the IPN webhook processes.
   - `completed`: "Payment confirmed ✓" with green styling, show Rivhit document number and link to invoice
   - `failed`: "Payment failed" with red styling, show error message, offer "Try Again" link that takes them back to checkout
   - `cancelled`: "Payment was cancelled" with option to retry
3. Show the Rivhit invoice/receipt link if `rivhitDocumentLink` exists in the payment transaction
4. Keep all existing order details display (items, shipping, totals)
5. Handle the case where `payment` is `null` (order exists but no payment transaction yet — shouldn't happen in normal flow, but handle gracefully with "Awaiting payment" message)

**RTL Hebrew considerations:**
- Payment status labels in Hebrew:
  - pending: "התשלום בעיבוד..."
  - completed: "התשלום אושר ✓"
  - failed: "התשלום נכשל"
  - cancelled: "התשלום בוטל"
- Layout should respect existing RTL direction
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to `/order-confirmation/{orderId}` — payment status section renders
3. If payment is pending, loading state shows
4. Verify page is reactive (would auto-update when payment status changes via IPN)
  </verify>
  <done>
Order confirmation page shows real-time payment status from paymentTransactions table. Status auto-updates reactively when IPN webhook processes. Hebrew labels for all payment states. Invoice link shown when available.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Rivhit payment flow: 2-step checkout (Shipping → Review & Pay) that creates an order and redirects to Rivhit's hosted payment page. Order confirmation page shows reactive payment status.
  </what-built>
  <how-to-verify>
1. Start the dev server: `pnpm dev` (storefront on localhost:3000)
2. Add wine items to cart
3. Go to checkout — verify only 2 steps: Shipping and Review & Pay
4. Fill in shipping details, advance to Review step
5. Verify "Proceed to Secure Payment" button is visible with Rivhit branding
6. **If RIVHIT_API_TOKEN env var is set in Convex:**
   - Click "Proceed to Secure Payment"
   - Should redirect to Rivhit's hosted payment page
   - Complete test payment on Rivhit page
   - Should redirect back to order confirmation
   - Payment status should update from "pending" to "completed"
7. **If RIVHIT_API_TOKEN is NOT yet set:**
   - Click "Proceed to Secure Payment"
   - Should show error message (API token not configured)
   - Verify error handling UI looks correct
8. Check that no card number/CVV inputs exist anywhere in the checkout
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Checkout flow is 2 steps, no mock card inputs
3. Order is created before payment redirect
4. Rivhit payment URL is requested from backend
5. User is redirected to Rivhit hosted page
6. After payment, user returns to order confirmation
7. Payment status updates reactively via IPN webhook
</verification>

<success_criteria>
- Mock card payment UI is completely removed
- Checkout creates order first, then redirects to Rivhit
- Order confirmation shows real payment status
- Error handling for failed Rivhit API calls
- RTL Hebrew labels for payment states
- Payment flow works end-to-end with Rivhit test environment
</success_criteria>

<output>
After completion, create `.planning/phases/03-rivhit-payment/03-02-SUMMARY.md`
</output>
