---
phase: 03-rivhit-payment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/rivhit.ts
  - convex/schema.ts
  - convex/http.ts
  - packages/shared-types/src/index.ts
autonomous: true
user_setup:
  - service: rivhit
    why: "Payment processing and invoice generation for Israeli market"
    env_vars:
      - name: RIVHIT_API_TOKEN
        source: "Rivhit Dashboard or via ApiToken.Get endpoint with your username/password/company_id"
    dashboard_config:
      - task: "Get or generate API token"
        location: "Rivhit account settings or call POST https://api.rivhit.co.il/online/RivhitOnlineAPI.svc/ApiToken.Get with {username, password, company_id}"

must_haves:
  truths:
    - "Convex backend can create a Rivhit hosted payment page URL for a given order"
    - "Rivhit IPN webhook notifications are received and processed by Convex HTTP router"
    - "Payment transactions are tracked in a dedicated Convex table with status lifecycle"
    - "System supports test environment with easy switch to production"
  artifacts:
    - path: "convex/rivhit.ts"
      provides: "Rivhit API client actions and payment mutations"
      exports: ["createPaymentPage", "handleIpnWebhook", "getPaymentByOrderId"]
    - path: "convex/schema.ts"
      provides: "paymentTransactions table schema"
      contains: "paymentTransactions"
    - path: "convex/http.ts"
      provides: "IPN webhook HTTP route"
      contains: "rivhit/ipn"
    - path: "packages/shared-types/src/index.ts"
      provides: "Rivhit payment types"
      contains: "RivhitPaymentStatus"
  key_links:
    - from: "convex/rivhit.ts"
      to: "https://api.rivhit.co.il/online/RivhitOnlineAPI.svc/Document.Page"
      via: "fetch in Convex action"
      pattern: "Document\\.Page"
    - from: "convex/http.ts"
      to: "convex/rivhit.ts"
      via: "IPN webhook handler calls mutation"
      pattern: "handleIpnWebhook"
---

<objective>
Create the Rivhit payment gateway foundation: API client, payment transaction table, shared types, and IPN webhook endpoint.

Purpose: Establish the server-side infrastructure for Rivhit payment processing so the storefront checkout can redirect customers to Rivhit's secure hosted payment page and receive payment confirmations via IPN webhook.

Output: Convex action that creates Rivhit payment page URLs, webhook endpoint that processes payment notifications, and a paymentTransactions table tracking payment lifecycle.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@convex/schema.ts
@convex/orders.ts
@convex/http.ts
@packages/shared-types/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Rivhit payment types and paymentTransactions schema</name>
  <files>
    packages/shared-types/src/index.ts
    convex/schema.ts
  </files>
  <action>
1. In `packages/shared-types/src/index.ts`, add the following types AFTER the existing payment types:

```typescript
// Rivhit Payment Gateway Types
export type RivhitPaymentStatus = 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled';

export type RivhitEnvironment = 'test' | 'production';

export interface RivhitDocumentPageRequest {
  api_token: string;
  document_type: number; // Invoice-Receipt type ID from Rivhit
  receipt_type?: number;
  customer_id?: number;
  last_name?: string;
  first_name?: string;
  address?: string;
  city?: string;
  zipcode?: number;
  phone?: string;
  email_to?: string;
  comments?: string;
  price_include_vat?: boolean;
  items: Array<{
    catalog_number?: string;
    quantity: number;
    price: number;
    description: string;
    item_id?: number;
  }>;
  redirect_url: string;
  ipn_url: string;
  ipn_data?: string;
  create_customer?: boolean;
  find_by_mail?: boolean;
  find_by_phone?: boolean;
  send_mail?: boolean;
}

export interface RivhitDocumentPageResponse {
  error_code: number;
  client_message: string | null;
  debug_message: string | null;
  data: {
    page_url: string;
  } | null;
}

export interface RivhitPaymentTransaction {
  orderId: string;
  rivhitPaymentUrl?: string;
  rivhitDocumentType?: number;
  rivhitDocumentNumber?: number;
  rivhitCustomerId?: number;
  rivhitDocumentLink?: string;
  rivhitConfirmationNumber?: number;
  status: RivhitPaymentStatus;
  amount: number;
  environment: RivhitEnvironment;
  ipnData?: string;
  errorMessage?: string;
  createdAt: string;
  updatedAt: string;
}
```

2. In `convex/schema.ts`, add a `paymentTransactions` table definition alongside existing tables:

```typescript
paymentTransactions: defineTable({
  orderId: v.id("orders"),
  rivhitPaymentUrl: v.optional(v.string()),
  rivhitDocumentType: v.optional(v.number()),
  rivhitDocumentNumber: v.optional(v.number()),
  rivhitCustomerId: v.optional(v.number()),
  rivhitDocumentLink: v.optional(v.string()),
  rivhitConfirmationNumber: v.optional(v.number()),
  status: v.string(), // RivhitPaymentStatus
  amount: v.number(),
  environment: v.string(), // 'test' | 'production'
  ipnData: v.optional(v.string()),
  errorMessage: v.optional(v.string()),
  createdAt: v.string(),
  updatedAt: v.string(),
}).index("by_orderId", ["orderId"])
  .index("by_status", ["status"]),
```

Important: The `orderId` field uses `v.id("orders")` to maintain referential integrity with the orders table. Add two indexes: `by_orderId` for looking up payment by order, and `by_status` for admin filtering.
  </action>
  <verify>
Run `npx convex dev --once` (or check that Convex schema push succeeds). Verify the new table appears in the Convex dashboard.
  </verify>
  <done>
paymentTransactions table exists in schema with orderId index. Shared types include RivhitPaymentStatus, RivhitDocumentPageRequest, RivhitDocumentPageResponse, and RivhitPaymentTransaction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Rivhit API client action and IPN webhook handler</name>
  <files>
    convex/rivhit.ts
    convex/http.ts
  </files>
  <action>
1. Create `convex/rivhit.ts` with the following:

**Constants:**
```typescript
const RIVHIT_API_BASE = "https://api.rivhit.co.il/online/RivhitOnlineAPI.svc";

// Standard Israeli document types for Rivhit
const RIVHIT_DOCUMENT_TYPES = {
  INVOICE_RECEIPT: 305, // חשבונית מס / קבלה (Tax Invoice + Receipt - most common for e-commerce)
  INVOICE: 300,         // חשבונית מס (Tax Invoice only)
  RECEIPT: 400,         // קבלה (Receipt only)
  ORDER: 100,           // הזמנה (Order/Quote)
} as const;
```

**`createPaymentPage` action:**
- Takes: `orderId` (Id<"orders">)
- Reads the order from the database using `ctx.runQuery`
- Reads `RIVHIT_API_TOKEN` from environment variables using `process.env.RIVHIT_API_TOKEN`
- Determines environment from `process.env.RIVHIT_ENVIRONMENT` (default: 'test')
- Builds the Convex site URL for `redirect_url` and `ipn_url` from `process.env.CONVEX_SITE_URL`
  - redirect_url: `${siteUrl}/rivhit/redirect?orderId=${orderId}` (this will be handled in plan 02 on the frontend side)
  - ipn_url: `${siteUrl}/rivhit/ipn`
  - ipn_data: JSON.stringify({ orderId, paymentTransactionId }) — so we can match the IPN callback to our records
- Constructs the `Document.Page` request body:
  ```json
  {
    "api_token": apiToken,
    "document_type": 305,  // Invoice-Receipt
    "receipt_type": 400,   // Receipt
    "last_name": order.customerName,
    "email_to": order.customerEmail,
    "phone": order.customerPhone,
    "address": order.shippingStreet,
    "city": order.shippingCity,
    "price_include_vat": true,
    "items": cartItems.map(item => ({
      "description": item.productName,
      "quantity": item.quantity,
      "price": item.price
    })),
    "redirect_url": redirectUrl,
    "ipn_url": ipnUrl,
    "ipn_data": ipnData,
    "create_customer": true,
    "find_by_mail": true,
    "send_mail": true
  }
  ```
- Calls `fetch(RIVHIT_API_BASE + "/Document.Page", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(requestBody) })`
- Parses the response as JSON
- If `error_code === 0` and `data.page_url` exists:
  - Creates a `paymentTransactions` record via `ctx.runMutation` with status `'pending'`, the payment URL, and the order amount
  - Updates the order's `paymentTransactionId` field to the generated mock value (no schema change needed - we'll use the existing `paymentTransactionId` field to store the Convex paymentTransaction ID)
  - Returns `{ success: true, paymentUrl: data.page_url, paymentTransactionId }`
- If error: Creates a paymentTransactions record with status `'failed'`, stores error message, returns `{ success: false, error: response.client_message || response.debug_message }`

**`handleIpnNotification` mutation:**
- Internal mutation (not exposed to clients)
- Takes: raw IPN POST body as string
- Parses the body to extract orderId and payment result
- Looks up the paymentTransaction by orderId
- Updates the paymentTransaction status to 'completed' or 'failed' based on the IPN data
- If completed: Updates the linked order's status to 'processing' and stores the Rivhit document number/link in the paymentTransaction record
- Logs the full IPN data for debugging

**`getPaymentByOrderId` query:**
- Takes: orderId (Id<"orders">)
- Returns the paymentTransaction record for the given order using the by_orderId index
- Returns null if no payment exists

**Helper internal mutation: `createPaymentTransaction`**
- Creates the paymentTransactions record
- Returns the new record ID

**Helper internal mutation: `updatePaymentTransaction`**
- Updates a paymentTransactions record by ID

2. In `convex/http.ts`, add the IPN webhook route:

After the existing auth routes, add:
```typescript
import { internal } from "./_generated/api";

http.route({
  path: "/rivhit/ipn",
  method: "POST",
  handler: httpAction(async (ctx, request) => {
    try {
      const body = await request.text();
      console.log("[Rivhit IPN] Received:", body);
      
      await ctx.runMutation(internal.rivhit.handleIpnNotification, { 
        rawBody: body 
      });
      
      return new Response("OK", { status: 200 });
    } catch (error) {
      console.error("[Rivhit IPN] Error:", error);
      return new Response("Internal Server Error", { status: 500 });
    }
  }),
});
```

Also add a redirect handler for when the user returns from the Rivhit payment page:
```typescript
http.route({
  path: "/rivhit/redirect",
  method: "GET",
  handler: httpAction(async (ctx, request) => {
    const url = new URL(request.url);
    const orderId = url.searchParams.get("orderId");
    // Redirect to the storefront order confirmation page
    const storefrontUrl = process.env.VITE_STOREFRONT_URL || "http://localhost:3000";
    return new Response(null, {
      status: 302,
      headers: { Location: `${storefrontUrl}/order-confirmation/${orderId}` },
    });
  }),
});
```

**Important implementation notes:**
- Use `"use node"` directive at top of rivhit.ts since it uses `fetch` and `process.env`
- Import action/internalMutation/query from `./_generated/server`
- The `createPaymentPage` must be an `action` (not mutation) because it makes external HTTP calls
- Use `internalMutation` for `handleIpnNotification` and helper mutations since they should only be called from actions/HTTP handlers, not directly from the client
- Use `query` for `getPaymentByOrderId` since it's read-only and needs to be reactive
  </action>
  <verify>
1. Run `npx convex dev --once` to push the new functions
2. Test the SayHello endpoint: `curl https://api.rivhit.co.il/online/RivhitOnlineAPI.svc/test` should return an echo
3. Verify all 3 functions appear in the Convex dashboard: `rivhit:createPaymentPage` (action), `rivhit:handleIpnNotification` (internal mutation), `rivhit:getPaymentByOrderId` (query)
4. Verify the HTTP route `/rivhit/ipn` is registered
  </verify>
  <done>
Convex action `createPaymentPage` calls Rivhit Document.Page API and returns a payment page URL. Internal mutation `handleIpnNotification` processes IPN callbacks and updates payment/order status. Query `getPaymentByOrderId` returns payment status for an order. HTTP routes registered for `/rivhit/ipn` (POST) and `/rivhit/redirect` (GET).
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds without errors
2. paymentTransactions table visible in Convex dashboard
3. Three rivhit functions registered: createPaymentPage, handleIpnNotification, getPaymentByOrderId
4. HTTP routes `/rivhit/ipn` and `/rivhit/redirect` registered
5. Types exported from @shared/types
</verification>

<success_criteria>
- Rivhit API client can construct and send Document.Page requests
- Payment transactions are persisted with full lifecycle tracking
- IPN webhook endpoint is reachable and processes notifications
- Redirect endpoint sends users back to storefront after payment
- Test/production environment switching via env var
</success_criteria>

<output>
After completion, create `.planning/phases/03-rivhit-payment/03-01-SUMMARY.md`
</output>
