---
phase: 07-optimize-loading
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/admin/pages/Products.tsx
  - apps/admin/pages/Orders.tsx
  - apps/admin/pages/Users.tsx
  - apps/admin/pages/Categories.tsx
  - apps/admin/pages/Coupons.tsx
  - apps/admin/pages/CartRules.tsx
  - apps/admin/components/shared/LoadingState.tsx
autonomous: true
requirements: []
must_haves:
  truths:
    - "Pages show data immediately on return visits (no spinner)"
    - "Only first visit to any page shows loading spinner"
    - "Background refresh shows subtle indicator, not blocking spinner"
  artifacts:
    - path: "apps/admin/pages/Products.tsx"
      provides: "Updated to use hasEverLoaded pattern"
      changes: ["conditional LoadingState only on first load"]
    - path: "apps/admin/pages/Orders.tsx"
      provides: "Updated to use hasEverLoaded pattern"
      changes: ["conditional LoadingState only on first load"]
    - path: "apps/admin/pages/Users.tsx"
      provides: "Updated to use hasEverLoaded pattern"
      changes: ["conditional LoadingState only on first load"]
    - path: "apps/admin/pages/Categories.tsx"
      provides: "Updated to use hasEverLoaded pattern"
      changes: ["conditional LoadingState only on first load"]
    - path: "apps/admin/pages/Coupons.tsx"
      provides: "Updated to use hasEverLoaded pattern"
      changes: ["conditional LoadingState only on first load"]
    - path: "apps/admin/pages/CartRules.tsx"
      provides: "Updated to use hasEverLoaded pattern"
      changes: ["conditional LoadingState only on first load"]
    - path: "apps/admin/components/shared/LoadingState.tsx"
      provides: "Smart loading component"
      adds: ["variant prop for full vs subtle loading"]
  key_links:
    - from: "LoadingState.tsx"
      to: "Products.tsx"
      via: "uses variant prop"
    - from: "useEntityList"
      to: "Products.tsx"
      via: "returns hasEverLoaded"
---

<objective>
Update all list pages to use the new cache-aware loading states.

Purpose: Pages should only show full spinner on first visit. Return visits show data instantly.

Output: Updated pages with smart loading behavior
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@apps/admin/pages/Products.tsx
@apps/admin/pages/Orders.tsx
@apps/admin/pages/Users.tsx
@apps/admin/pages/Categories.tsx
@apps/admin/pages/Coupons.tsx
@apps/admin/pages/CartRules.tsx
@apps/admin/components/shared/LoadingState.tsx

The key change: Replace `if (isLoading) return <LoadingState />` with:
```typescript
// Only show spinner on first load, not on return visits
if (isLoading && !hasEverLoaded) return <LoadingState />;
// Optionally: show subtle refresh indicator if isRefreshing
```

This means:
- First visit: hasEverLoaded=false, isLoading=true → show spinner
- Return visit: hasEverLoaded=true, isLoading=false → show data immediately
- Background refresh: hasEverLoaded=true, isRefreshing=true → subtle indicator or nothing
</context>

<tasks>

<task type="auto">
  <name>Enhance LoadingState component</name>
  <files>apps/admin/components/shared/LoadingState.tsx</files>
  <action>
    Add variant prop support to LoadingState:

    ```typescript
    interface LoadingStateProps {
      message?: string;
      variant?: 'full' | 'subtle';  // full = big spinner, subtle = small indicator
    }
    ```

    - variant="full" (default): Current behavior - big spinner, centered, minH="400px"
    - variant="subtle": Small inline spinner for background refresh scenarios

    Update the component to accept and use the variant prop.
  </action>
  <verify>
    LoadingState accepts variant prop
    Can render both full and subtle versions
  </verify>
  <done>
    LoadingState component enhanced with variant support
  </done>
</task>

<task type="auto">
  <name>Update Products page to use cache-aware loading</name>
  <files>apps/admin/pages/Products.tsx</files>
  <action>
    In Products.tsx:

    1. Destructure hasEverLoaded from the hook return
    2. Change loading check from:
       ```typescript
       if (isLoading) return <LoadingState message="טוען מוצרים..." />;
       ```
       To:
       ```typescript
       // Only show spinner on first load (cold cache)
       if (isLoading && !hasEverLoaded) {
         return <LoadingState message="טוען מוצרים..." />;
       }
       // Show subtle refresh indicator if refetching with existing data
       if (isRefreshing) {
         return (
           <>
             <LoadingState variant="subtle" message="מרענן..." />
             {/* Still show old data while refreshing */}
             <VStack gap="0" align="stretch" h="full">
               {/* ... rest of component with existing data ... */}
             </VStack>
           </>
         );
       }
       ```

    Actually, simpler approach - just show data immediately if we have it:
    ```typescript
    // Only show full spinner on first load
    if (isLoading && !hasEverLoaded) return <LoadingState />;
    // If we have data, show it even if refreshing in background
    ```
  </action>
  <verify>
    Navigate away and back to Products - should show data instantly
  </verify>
  <done>
    Products page uses cache-aware loading
  </done>
</task>

<task type="auto">
  <name>Update Orders page to use cache-aware loading</name>
  <files>apps/admin/pages/Orders.tsx</files>
  <action>
    Same pattern as Products:
    1. Destructure hasEverLoaded
    2. Change loading check to only show spinner on first load
  </action>
  <verify>
    Navigate away and back to Orders - should show data instantly
  </verify>
  <done>
    Orders page uses cache-aware loading
  </done>
</task>

<task type="auto">
  <name>Update Users page to use cache-aware loading</name>
  <files>apps/admin/pages/Users.tsx</files>
  <action>
    Same pattern as Products:
    1. Destructure hasEverLoaded
    2. Change loading check to only show spinner on first load
  </action>
  <verify>
    Navigate away and back to Users - should show data instantly
  </verify>
  <done>
    Users page uses cache-aware loading
  </done>
</task>

<task type="auto">
  <name>Update Categories page to use cache-aware loading</name>
  <files>apps/admin/pages/Categories.tsx</files>
  <action>
    Same pattern as Products:
    1. Destructure hasEverLoaded
    2. Change loading check to only show spinner on first load
  </action>
  <verify>
    Navigate away and back to Categories - should show data instantly
  </verify>
  <done>
    Categories page uses cache-aware loading
  </done>
</task>

<task type="auto">
  <name>Update Coupons page to use cache-aware loading</name>
  <files>apps/admin/pages/Coupons.tsx</files>
  <action>
    Same pattern as Products:
    1. Destructure hasEverLoaded
    2. Change loading check to only show spinner on first load
  </action>
  <verify>
    Navigate away and back to Coupons - should show data instantly
  </verify>
  <done>
    Coupons page uses cache-aware loading
  </done>
</task>

<task type="auto">
  <name>Update CartRules page to use cache-aware loading</name>
  <files>apps/admin/pages/CartRules.tsx</files>
  <action>
    Same pattern as Products:
    1. Destructure hasEverLoaded
    2. Change loading check to only show spinner on first load
  </action>
  <verify>
    Navigate away and back to CartRules - should show data instantly
  </verify>
  <done>
    CartRules page uses cache-aware loading
  </done>
</task>

</tasks>

<verification>
Test the full flow:
1. Hard refresh (cold start) - visit each page for the first time → should show spinner
2. Navigate: Dashboard → Products → Orders → Users → Products
3. Return to Products → should show data INSTANTLY without any spinner
</verification>

<success_criteria>
- [x] Products shows data instantly on return visits
- [x] Orders shows data instantly on return visits
- [x] Users shows data instantly on return visits
- [x] Categories shows data instantly on return visits
- [x] Coupons shows data instantly on return visits
- [x] CartRules shows data instantly on return visits
- [x] First visit still shows appropriate loading state
</success_criteria>

<output>
After completion, create `.planning/phases/07-optimize-loading/07-02-SUMMARY.md`
</output>
