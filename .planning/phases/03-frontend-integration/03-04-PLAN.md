---
phase: 3
plan: 4
type: integration
autonomous: true
wave: 3
depends_on: ["03-03"]
---

# Plan 3-4: Checkout & Orders Integration

Migrate the checkout flow and order management from Appwrite to Convex.

## Objective
Enable customers to place orders and view their order history using Convex as the backend.

## Context Files
- @convex/orders.ts
- @apps/storefront/pages/CheckoutPage.tsx
- @apps/storefront/pages/OrderConfirmationPage.tsx
- @apps/storefront/pages/DashboardPage.tsx

## Tasks

### 1. Backend: Update Orders Mutation [type="auto"]
- [ ] Update `convex/orders.ts` `create` mutation to:
    - [ ] Accept full item details (`productId`, `productName`, `productImage`, etc.)
    - [ ] Atomically insert into `orderItems` table
    - [ ] Call `coupons.incrementUsage` if a coupon is present
- [ ] Verify mutation works with `npx convex dev`

### 2. Frontend: Refactor Checkout Page [type="auto"]
- [ ] Update `apps/storefront/pages/CheckoutPage.tsx`:
    - [ ] Import `api` and `useMutation` from `convex/react`
    - [ ] Replace `useCreateOrderMutation` with `useMutation(api.orders.create)`
    - [ ] Update form submission logic to match Convex schema
    - [ ] Handle successful redirection to order confirmation

### 3. Frontend: Refactor Order Confirmation [type="auto"]
- [ ] Update `apps/storefront/pages/OrderConfirmationPage.tsx`:
    - [ ] Use `useQuery(api.orders.get, { orderId })` to fetch details
    - [ ] Update component to render data from Convex

### 4. Frontend: Order History in Dashboard [type="auto"]
- [ ] Update `apps/storefront/components/Dashboard/OrdersTab.tsx` (or equivalent):
    - [ ] Fetch history using `api.orders.listByCustomer`
    - [ ] Ensure proper date and currency formatting (â‚ª)

## Verification Criteria
- [ ] Order placed successfully via checkout page
- [ ] `orderItems` table populated correctly for new orders
- [ ] Coupon usage incremented (if applicable)
- [ ] Order details viewable on confirmation page
- [ ] History visible in user dashboard

## Success Criteria
- [ ] Customer can complete end-to-end checkout flow
- [ ] All order data persists in Convex (no Appwrite dependencies)
- [ ] Storefront order management is fully reactive
