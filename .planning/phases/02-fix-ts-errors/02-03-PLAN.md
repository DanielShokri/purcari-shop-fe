---
phase: 02-fix-ts-errors
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/admin/hooks/useCartRuleEditor.ts
  - apps/admin/pages/CartRules.tsx
  - apps/admin/pages/Coupons.tsx
  - apps/admin/pages/Users.tsx
  - apps/admin/pages/OrderDetails.tsx
autonomous: true

must_haves:
  truths:
    - useCartRuleEditor uses correct string literal types for status
    - useQuery calls include required second argument (empty object or args)
    - Id generic type helper doesn't use string template literal
  artifacts:
    - path: "apps/admin/hooks/useCartRuleEditor.ts"
      provides: "Cart rule form hook with proper types"
    - path: "apps/admin/pages/CartRules.tsx"
      provides: "Cart rules page with proper useQuery call"
    - path: "apps/admin/pages/Coupons.tsx"
      provides: "Coupons page with proper useQuery call"
    - path: "apps/admin/pages/Users.tsx"
      provides: "Users page with proper Id type handling"
    - path: "apps/admin/pages/OrderDetails.tsx"
      provides: "Order details with proper Id type handling"
  key_links:
    - from: "useCartRuleEditor"
      to: "CartRuleStatus type"
      via: "string literal 'active'"
---

<objective>
Fix TypeScript errors in admin hooks and pages related to form types, useQuery arguments, and Id generic constraints.

Purpose: Admin UI hooks and pages need proper typing to work with the shared types and Convex queries.
Output: All admin hooks and pages compile without type errors.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Current issues:
1. useCartRuleEditor.ts line 48: 'active' is not assignable to CartRuleStatus (type alias vs enum)
2. useCartRuleEditor.ts line 150: handleSubmit type mismatch
3. CartRules.tsx line 12: useQuery missing second argument
4. Coupons.tsx line 13: useQuery missing second argument
5. Users.tsx lines 23, 41: Id<typeof tableName> constraint issue and useQuery missing arg
6. OrderDetails.tsx line 28: Id<typeof tableName> constraint issue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix useCartRuleEditor status type</name>
  <files>apps/admin/hooks/useCartRuleEditor.ts</files>
  <action>
    Line 48 has `status: 'active'` which now needs to match the CartRuleStatus type alias ('draft' | 'active' | 'paused').

    The issue is the interface CartRuleForm uses CartRuleStatus from @shared/types, which after Plan 01 is a type alias.

    Fix line 48:
    ```typescript
    status: 'active' as const,
    ```

    Or update the CartRuleForm interface to use the string literal type directly:
    ```typescript
    status: 'draft' | 'active' | 'paused';
    ```

    Also check the import at line 8 - ensure CartRuleStatus is imported correctly as a type.
  </action>
  <verify>npx tsc --noEmit apps/admin/hooks/useCartRuleEditor.ts 2>&1 | grep "TS2322\|status" | head -5</verify>
  <done>No TS2322 error on status property</done>
</task>

<task type="auto">
  <name>Task 2: Fix useCartRuleEditor handleSubmit type</name>
  <files>apps/admin/hooks/useCartRuleEditor.ts</files>
  <action>
    Line 150: `handleSubmit(onSubmit)()` has a type mismatch.

    The onSubmit function is typed as `(data: CartRuleForm) => Promise<void>` but handleSubmit expects `SubmitHandler<TFieldValues>`.

    The issue is that useForm<CartRuleForm> creates a generic TFieldValues that extends FieldValues, but CartRuleForm has required fields that FieldValues doesn't have.

    Fix by ensuring CartRuleForm extends FieldValues properly, or by using the handleSubmit pattern correctly:
    ```typescript
    const handleSave = handleSubmit(async (data) => {
      await onSubmit(data);
    });
    ```

    Actually, looking at the code, the issue might be that handleSubmit returns a function that needs to be called with the event. The current code `handleSubmit(onSubmit)()` is correct but TypeScript is complaining about the type compatibility.

    Try changing line 149-151 to:
    ```typescript
    const handleSave = () => {
      return handleSubmit(onSubmit)();
    };
    ```

    Or properly type the onSubmit to match react-hook-form's expectations.
  </action>
  <verify>npx tsc --noEmit apps/admin/hooks/useCartRuleEditor.ts 2>&1 | grep "TS2345\|handleSubmit" | head -5</verify>
  <done>No TS2345 error on handleSubmit call</done>
</task>

<task type="auto">
  <name>Task 3: Fix useQuery missing arguments</name>
  <files>apps/admin/pages/CartRules.tsx, apps/admin/pages/Coupons.tsx, apps/admin/pages/Users.tsx</files>
  <action>
    Convex's useQuery requires 2 arguments when the query function has args. When the query takes no args, pass an empty object {}.

    CartRules.tsx line 12:
    ```typescript
    const cartRules = useQuery(api.cartRules.get, {});
    ```

    Coupons.tsx line 13:
    ```typescript
    const coupons = useQuery(api.coupons.list, {});
    ```

    Users.tsx line 41:
    ```typescript
    const users = useQuery(api.users.listAll, {});
    ```

    The {} satisfies the requirement for a second argument even when the query doesn't require specific args.
  </action>
  <verify>npx tsc --noEmit apps/admin/pages/CartRules.tsx apps/admin/pages/Coupons.tsx apps/admin/pages/Users.tsx 2>&1 | grep "TS2554\|Expected 2" | head -5</verify>
  <done>No TS2554 errors about expected 2 arguments</done>
</task>

<task type="auto">
  <name>Task 4: Fix Id generic constraint in Users.tsx and OrderDetails.tsx</name>
  <files>apps/admin/pages/Users.tsx, apps/admin/pages/OrderDetails.tsx</files>
  <action>
    The isValidConvexId function uses `Id<typeof tableName>` where tableName is a string parameter. TypeScript requires the type parameter for Id to be a literal table name, not a generic string.

    Change from:
    ```typescript
    const isValidConvexId = (id: string, tableName: string): id is Id<typeof tableName> => {
    ```

    To use a type assertion instead:
    ```typescript
    const isValidConvexId = (id: string, tableName: string): boolean => {
      return typeof id === 'string' && id.startsWith(`${tableName}:`) && id.length > tableName.length + 10;
    };
    ```

    And update asUserId to use type assertion:
    ```typescript
    const asUserId = (id: string): Id<"users"> | null => {
      return isValidConvexId(id, "users") ? id as Id<"users"> : null;
    };
    ```

    Apply the same fix to OrderDetails.tsx.
  </action>
  <verify>npx tsc --noEmit apps/admin/pages/Users.tsx apps/admin/pages/OrderDetails.tsx 2>&1 | grep "TS2344\|constraint" | head -5</verify>
  <done>No TS2344 errors about type constraints</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` on each modified file
2. Verify useQuery calls have proper arguments
3. Verify Id type helpers work correctly
</verification>

<success_criteria>
- No TS2322 errors (type not assignable)
- No TS2345 errors (argument not assignable)
- No TS2554 errors (expected 2 arguments)
- No TS2344 errors (type constraint)
- All useQuery calls have proper second argument
</success_criteria>

<output>
After completion, create `.planning/phases/02-fix-ts-errors/02-03-SUMMARY.md`
</output>
