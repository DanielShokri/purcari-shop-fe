---
phase: 02-fix-ts-errors
plan: 04
type: execute
wave: 4
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - apps/admin/components/cart-rules/CartRuleTableRow.tsx
  - apps/admin/components/notifications/NotificationItem.tsx
  - apps/admin/components/products/ProductTableRow.tsx
  - apps/storefront/components/ProductCard.tsx
  - apps/admin/pages/Analytics.tsx
autonomous: true

must_haves:
  truths:
    - CartRuleTableRow uses type guards for config properties
    - NotificationItem handles NotificationType correctly
    - Product components display bigint values properly
    - Analytics.tsx handles optional retention property
  artifacts:
    - path: "apps/admin/components/cart-rules/CartRuleTableRow.tsx"
      provides: "Cart rule row with proper type narrowing"
    - path: "apps/admin/components/notifications/NotificationItem.tsx"
      provides: "Notification display with proper type handling"
    - path: "apps/admin/components/products/ProductTableRow.tsx"
      provides: "Product row with proper number types"
    - path: "apps/storefront/components/ProductCard.tsx"
      provides: "Product card with proper number types"
    - path: "apps/admin/pages/Analytics.tsx"
      provides: "Analytics page with optional retention"
  key_links:
    - from: "CartRuleTableRow"
      to: "CartRuleConfig discriminated union"
      via: "type guards checking config.type"
---

<objective>
Fix TypeScript errors in React components related to union type narrowing, type compatibility, and optional property handling.

Purpose: Components need to properly narrow union types and handle optional properties to compile correctly.
Output: All components compile without type errors and render correctly.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Current issues:
1. CartRuleTableRow.tsx lines 39, 40, 41, 42, 43: Properties don't exist on union type; case type not comparable
2. NotificationItem.tsx line 87: NotificationType enum vs string literal mismatch
3. ProductTableRow.tsx line 32: bigint not assignable to number (should be fixed by Plan 01)
4. ProductCard.tsx line 175: bigint not assignable to ReactNode (should be fixed by Plan 01)
5. Analytics.tsx lines 250, 251: retention property doesn't exist on summary
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CartRuleTableRow type narrowing</name>
  <files>apps/admin/components/cart-rules/CartRuleTableRow.tsx</files>
  <action>
    The formatValue() function uses switch on cartRule.ruleType but tries to access config properties that don't exist on all union members.

    The CartRuleConfig is a discriminated union with a `type` property:
    - BuyXGetYConfig has type: 'buy_x_get_y', buyQuantity, getQuantity
    - BulkDiscountConfig has type: 'bulk_discount', discountPercentage
    - ShippingConfig has type: 'shipping', minOrderAmount

    Fix the switch statement to use the discriminant (config.type instead of cartRule.ruleType):
    ```typescript
    const formatValue = (): string => {
      const config = cartRule.config;
      if (!config) return '-';

      switch (config.type) {
        case 'shipping':
          return `מעל ₪${config.minOrderAmount}`;
        case 'bulk_discount':
          return `${config.discountPercentage}%`;
        case 'buy_x_get_y':
          return `קנה ${config.buyQuantity} קבל ${config.getQuantity}`;
        default:
          return '-';
      }
    };
    ```

    Note: The case values should match the type property values, not the CartRuleType values.
  </action>
  <verify>npx tsc --noEmit apps/admin/components/cart-rules/CartRuleTableRow.tsx 2>&1 | grep "TS2339\|TS2678" | head -10</verify>
  <done>No TS2339 or TS2678 errors in CartRuleTableRow</done>
</task>

<task type="auto">
  <name>Task 2: Fix NotificationItem NotificationType</name>
  <files>apps/admin/components/notifications/NotificationItem.tsx</files>
  <action>
    Line 87: Argument of type '"order" | "info" | ...' is not assignable to NotificationType.

    The Notification interface has:
    ```typescript
    type: NotificationType | 'info' | 'warning' | 'error' | 'success' | 'order' | 'system';
    ```

    But getNotificationStyle expects NotificationType.

    Fix by either:
    1. Updating the Notification interface to use string literals instead of the enum
    2. Or creating a type guard/assertion
    3. Or updating getNotificationStyle to accept the wider type

    The simplest fix is to change the getNotificationStyle call to cast the type:
    ```typescript
    const style = getNotificationStyle(notification.type as NotificationType);
    ```

    Or better, update the Notification interface to not mix enum and string literals:
    ```typescript
    type: NotificationType;
    ```

    Check what getNotificationStyle expects and fix accordingly.
  </action>
  <verify>npx tsc --noEmit apps/admin/components/notifications/NotificationItem.tsx 2>&1 | grep "TS2345" | head -5</verify>
  <done>No TS2345 errors in NotificationItem</done>
</task>

<task type="auto">
  <name>Task 3: Verify Product components after shared-types fix</name>
  <files>apps/admin/components/products/ProductTableRow.tsx, apps/storefront/components/ProductCard.tsx</files>
  <action>
    After Plan 01 changes, Product.quantityInStock and Product.vintage should be number only (not number | bigint).

    Verify the errors are resolved by checking the TypeScript output:
    - ProductTableRow.tsx line 32: getStockBadge(product.quantityInStock)
    - ProductCard.tsx line 175: {product.vintage}

    If still errors, ensure the shared-types package changes have taken effect (may need to restart TypeScript server or rebuild).

    If ProductCard still has issues with vintage display, convert to string:
    ```typescript
    <span>{product.vintage?.toString()}</span>
    ```
  </action>
  <verify>npx tsc --noEmit apps/admin/components/products/ProductTableRow.tsx apps/storefront/components/ProductCard.tsx 2>&1 | grep "TS2322\|TS2345\|bigint" | head -5</verify>
  <done>No bigint-related errors in Product components</done>
</task>

<task type="auto">
  <name>Task 4: Fix Analytics.tsx optional retention property</name>
  <files>apps/admin/pages/Analytics.tsx</files>
  <action>
    Lines 250-251 try to access summary.retention but AnalyticsSummary interface has retention as optional (?).

    The code checks `summary?.retention &&` which should work, but TypeScript is complaining that retention doesn't exist.

    Check if the AnalyticsSummary interface was imported correctly from @shared/types. The interface should have:
    ```typescript
    retention?: {
      week1: number;
      week7: number;
      week30: number;
    };
    ```

    If the property exists but TypeScript doesn't see it, ensure the import is correct:
    ```typescript
    import { AnalyticsSummary } from '@shared/types';
    ```

    Or use optional chaining properly:
    ```typescript
    {summary?.retention && (
      <RetentionCard retention={summary.retention} />
    )}
    ```

    If retention truly doesn't exist in the type, either:
    1. Add it to the AnalyticsSummary interface in shared-types
    2. Remove the retention display code

    Check the actual AnalyticsSummary type being used in this file.
  </action>
  <verify>npx tsc --noEmit apps/admin/pages/Analytics.tsx 2>&1 | grep "TS2339.*retention" | head -5</verify>
  <done>No TS2339 errors about retention property</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` on each modified component
2. Verify CartRuleTableRow correctly narrows union types
3. Verify Product components display numbers correctly
4. Verify Analytics handles optional retention
</verification>

<success_criteria>
- No TS2339 errors (property does not exist)
- No TS2678 errors (type not comparable)
- No TS2345 errors (argument not assignable)
- No TS2322 errors (type not assignable)
- All components use proper type narrowing
</success_criteria>

<output>
After completion, create `.planning/phases/02-fix-ts-errors/02-04-SUMMARY.md`
</output>
