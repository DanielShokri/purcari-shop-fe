---
phase: 02-fix-ts-errors
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - convex/analytics/events.ts
  - convex/admin.ts
  - convex/coupons.ts
  - convex/orderItems.ts
  - convex/orders.ts
  - convex/crons.ts
autonomous: true

must_haves:
  truths:
    - ctx.session access is fixed with proper Convex auth pattern
    - args.query and args.limit have proper type assertions
    - args.code has proper type assertion
    - bigint quantities are converted to Number() before use
    - crons.ts type instantiation issue is resolved
  artifacts:
    - path: "convex/analytics/events.ts"
      provides: "Analytics event mutations with proper auth access"
    - path: "convex/admin.ts"
      provides: "Admin queries with proper typing"
    - path: "convex/coupons.ts"
      provides: "Coupon mutations with proper typing"
    - path: "convex/orderItems.ts"
      provides: "Order item creation with number conversion"
    - path: "convex/orders.ts"
      provides: "Order creation with number conversion"
    - path: "convex/crons.ts"
      provides: "Cron jobs without type recursion issues"
  key_links:
    - from: "analytics/events.ts"
      to: "Convex auth system"
      via: "ctx.auth.getUserIdentity()"
---

<objective>
Fix TypeScript errors in Convex backend functions related to type mismatches, unknown types, and bigint conversions.

Purpose: Backend functions must compile correctly to deploy. Type errors in Convex functions prevent the app from running.
Output: All Convex functions type-check correctly with proper type assertions and conversions.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Current issues:
1. convex/analytics/events.ts: ctx.session doesn't exist - need to use ctx.auth.getUserIdentity()
2. convex/admin.ts: args.query and args.limit are typed as unknown from v.any()
3. convex/coupons.ts: args.code is unknown
4. convex/orderItems.ts & orders.ts: item.quantity is bigint but needs to be number
5. convex/crons.ts: Type instantiation is excessively deep and possibly infinite
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ctx.session in analytics/events.ts</name>
  <files>convex/analytics/events.ts</files>
  <action>
    Replace ctx.session?.userId with ctx.auth.getUserIdentity() pattern.

    In trackEvent mutation (line 20):
    ```typescript
    const identity = await ctx.auth.getUserIdentity();
    const userId = identity?.subject;
    ```

    Apply the same fix to:
    - track mutation (line 64)
    - identifyUser mutation (line 101)
    - linkIdentity mutation (line 129)

    Note: These are mutations, so ctx.auth is available. The identity.subject contains the userId.
  </action>
  <verify>grep -n "ctx.session" convex/analytics/events.ts</verify>
  <done>No ctx.session references remain; all use ctx.auth.getUserIdentity()</done>
</task>

<task type="auto">
  <name>Task 2: Fix unknown types in admin.ts</name>
  <files>convex/admin.ts</files>
  <action>
    Add type assertions for args.query and args.limit.

    Line 49:
    ```typescript
    const searchQuery = (args.query as string).trim();
    ```

    Line 90 and 121 already use limit which should be number. The issue is the slice(0, limit) where limit comes from args.limit. Add assertion:
    ```typescript
    const limit = (args.limit as number | undefined) || 10;
    ```

    Also fix line 48 limit declaration - it's already declared, just need to ensure it's typed correctly.
  </action>
  <verify>npx tsc --noEmit convex/admin.ts 2>&1 | head -20</verify>
  <done>No TS2339 errors on trim(), slice() calls</done>
</task>

<task type="auto">
  <name>Task 3: Fix unknown type in coupons.ts</name>
  <files>convex/coupons.ts</files>
  <action>
    Find line 77 where args.code.toUpperCase() is called. Add type assertion:
    ```typescript
    code: (args.code as string).toUpperCase(),
    ```

    The args.code comes from a validator that likely uses v.string(), but TypeScript sees it as unknown. The type assertion is safe here.
  </action>
  <verify>npx tsc --noEmit convex/coupons.ts 2>&1 | grep -i "toUpperCase\|TS2339" | head -5</verify>
  <done>No TS2339 error on toUpperCase() call</done>
</task>

<task type="auto">
  <name>Task 4: Fix bigint to number conversion in orderItems.ts and orders.ts</name>
  <files>convex/orderItems.ts, convex/orders.ts</files>
  <action>
    In orderItems.ts line 31 and orders.ts line 113, item.quantity is bigint but the target type expects number.

    Convert to Number():
    ```typescript
    quantity: Number(item.quantity),
    ```

    This safely converts bigint to number. Since quantity should be reasonably small (not exceeding Number.MAX_SAFE_INTEGER), this is safe.
  </action>
  <verify>npx tsc --noEmit convex/orderItems.ts convex/orders.ts 2>&1 | grep -i "TS2322\|bigint" | head -5</verify>
  <done>No TS2322 errors about bigint not assignable to number</done>
</task>

<task type="auto">
  <name>Task 5: Fix type instantiation depth in crons.ts</name>
  <files>convex/crons.ts</files>
  <action>
    The error at line 13 is "Type instantiation is excessively deep and possibly infinite".

    This typically happens with recursive type definitions. The issue is likely with how internal.analytics.events.pruneOldEvents is referenced.

    Check if crons.ts has something like:
    ```typescript
    cron({
      name: "prune analytics",
      schedule: "0 2 * * *",
      handler: internal.analytics.events.pruneOldEvents,
    })
    ```

    The fix is to use a function wrapper instead of direct reference:
    ```typescript
    cron({
      name: "prune analytics",
      schedule: "0 2 * * *",
      handler: async (ctx) => {
        await ctx.runMutation(internal.analytics.events.pruneOldEvents, {});
      },
    })
    ```

    Read the file first to understand the current structure.
  </action>
  <verify>npx tsc --noEmit convex/crons.ts 2>&1 | grep -i "TS2589\|instantiation" | head -5</verify>
  <done>No TS2589 type instantiation errors</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` in convex/ directory to check all backend files
2. Verify all ctx.session references are replaced
3. Verify all unknown type assertions are added
4. Verify bigint conversions use Number()
</verification>

<success_criteria>
- No TS2339 errors (property does not exist on unknown)
- No TS2322 errors (bigint not assignable to number)
- No TS2589 errors (type instantiation too deep)
- All analytics mutations use ctx.auth.getUserIdentity()
</success_criteria>

<output>
After completion, create `.planning/phases/02-fix-ts-errors/02-02-SUMMARY.md`
</output>
