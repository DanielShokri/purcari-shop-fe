---
phase: 02-core-functions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [convex/users.ts, convex/userAddresses.ts]
autonomous: true
must_haves:
  truths:
    - "Admin can query and update user roles/status"
    - "Users can manage multiple shipping addresses"
    - "Address management correctly handles 'isDefault' flag logic"
  artifacts:
    - path: "convex/users.ts"
      provides: "User management functions"
    - path: "convex/userAddresses.ts"
      provides: "Address CRUD operations"
  key_links:
    - from: "convex/userAddresses.ts"
      to: "users table"
      via: "userId foreign key"
---

<objective>
Implement core Convex functions for User profile management and Address books.
Port logic from `authApi.ts` and `usersApi.ts` to Convex queries and mutations.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@convex/schema.ts
@apps/admin/services/api/usersApi.ts
@apps/storefront/services/api/authApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement User Management Functions</name>
  <files>convex/users.ts</files>
  <action>
    Create Convex query and mutation functions in `convex/users.ts`:
    - `get`: Retrieve the current user profile (using `auth.getUserIdentity`).
    - `list`: Admin-only function to list all users with pagination support.
    - `updateRole`: Mutation to update user roles (admin, editor, etc.).
    - `updateStatus`: Mutation to toggle user status (active, inactive).
    Ensure `updatedAt` is refreshed on mutations.
  </action>
  <verify>Run `npx convex run users:get` (if authenticated) or test via Convex Dashboard.</verify>
  <done>Basic user CRUD and role management functions are operational.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Address CRUD Functions</name>
  <files>convex/userAddresses.ts</files>
  <action>
    Create Convex functions in `convex/userAddresses.ts`:
    - `list`: Get all addresses for a specific `userId`.
    - `create`: Add new address. If `isDefault` is true, unset other defaults for the user.
    - `update`: Edit existing address. Handle `isDefault` toggle logic.
    - `remove`: Delete address.
    - `setDefault`: Dedicated mutation to change the default address for a user.
  </action>
  <verify>Test creating and removing addresses; verify that only one address can be 'isDefault' at a time.</verify>
  <done>User address management logic is complete and handles mutual exclusivity of default flag.</done>
</task>

</tasks>

<verification>
Verify that users can be managed and addresses are correctly linked to user IDs in the Convex data store.
</verification>

<success_criteria>
Admin and storefront can perform all required user and address operations via Convex.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-functions/02-01-SUMMARY.md`
</output>
