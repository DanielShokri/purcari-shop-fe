---
phase: 02-core-functions
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified: [convex/orders.ts, convex/orderItems.ts]
autonomous: true
must_haves:
  truths:
    - "Order creation is atomic and transactional"
    - "Customer can view their own order history"
    - "Admin can manage order status"
  artifacts:
    - path: "convex/orders.ts"
      provides: "Order lifecycle management"
    - path: "convex/orderItems.ts"
      provides: "Order line item details"
  key_links:
    - from: "convex/orderItems.ts"
      to: "orders table"
      via: "orderId foreign key"
---

<objective>
Implement order processing logic. This handles the transition from Cart to Order, including denormalizing address and payment info for historical accuracy.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@convex/schema.ts
@apps/storefront/services/api/ordersApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Order Creation Mutation</name>
  <files>convex/orders.ts</files>
  <action>
    Create the `create` mutation in `convex/orders.ts`:
    - Accept `customerName`, `customerEmail`, `shippingAddress`, `paymentInfo`, and `items`.
    - Calculate `subtotal`, `tax` (17% VAT), `shippingCost` (standard vs free), and `total`.
    - Create the order document with denormalized shipping and payment info.
    - Important: This mutation should return the `orderId` to trigger item creation.
  </action>
  <verify>Call `orders:create` via CLI and verify the document contains all calculated totals.</verify>
  <done>Primary order document creation logic is implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Order Items & Retrieval</name>
  <files>convex/orderItems.ts, convex/orders.ts</files>
  <action>
    Implement item management and queries:
    - In `convex/orderItems.ts`: `create` mutation to add items to an order.
    - In `convex/orders.ts`:
      - `get`: Fetch single order with its items (joined).
      - `listByCustomer`: Query for current user's orders (filter by `customerEmail`).
      - `listAll`: Admin-only query for all orders with status filtering.
      - `updateStatus`: Admin-only mutation to change status (pending -> processing -> shipped...).
  </action>
  <verify>Run `orders:get` and verify it correctly returns the order with all associated items.</verify>
  <done>Complete order history and management functions are available.</done>
</task>

</tasks>

<verification>
Verify transactional integrity (simulated via multiple mutations) and correct data joining for order details.
</verification>

<success_criteria>
Storefront can place orders and view history. Admin can see and update orders.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-functions/02-03-SUMMARY.md`
</output>
