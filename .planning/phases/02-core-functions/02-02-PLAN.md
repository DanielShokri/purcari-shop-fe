---
phase: 02-core-functions
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [convex/categories.ts, convex/products.ts]
autonomous: true
must_haves:
  truths:
    - "Admin can manage hierarchical categories"
    - "Products can be filtered by category, status, and custom attributes (wine type, price range)"
    - "Search works correctly in both Hebrew and English using Convex search indexes"
  artifacts:
    - path: "convex/categories.ts"
      provides: "Category management"
    - path: "convex/products.ts"
      provides: "Product catalog and search"
  key_links:
    - from: "convex/products.ts"
      to: "categories table"
      via: "category field"
---

<objective>
Implement the core product catalog logic. Port categories management and product listing/search from Appwrite to Convex.
</objective>

<execution_context>
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/danielshmuel.mirshukri/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@convex/schema.ts
@apps/storefront/services/api/productsApi.ts
@apps/storefront/services/api/categoriesApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Category CRUD Functions</name>
  <files>convex/categories.ts</files>
  <action>
    Create Convex functions in `convex/categories.ts`:
    - `list`: Get all categories sorted by `order`.
    - `get`: Get single category by ID or slug.
    - `create/update/remove`: Admin-only mutations for category management.
    Port existing logic for slugs and Hebrew names (`nameHe`).
  </action>
  <verify>Run `npx convex run categories:list` and verify order.</verify>
  <done>Category management is operational.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Product Catalog & Filters</name>
  <files>convex/products.ts</files>
  <action>
    Create core product queries in `convex/products.ts`:
    - `list`: Implement filtering by category, `wineType`, `onSale`, `isFeatured`, and `stockStatus`.
    - `getById`: Fetch single product.
    - `getByCategory`: Specialized query for category pages.
    - `getFeatured`: Helper for homepage.
    - `getOnSale`: Helper for sales page.
    Ensure `updatedAt` and `createdAt` are handled.
  </action>
  <verify>Test filtering via Convex dashboard using multiple parameters simultaneously.</verify>
  <done>Product listing and filtering logic matches previous Appwrite implementation but with native Convex performance.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Bilingual Search & Specialized Queries</name>
  <files>convex/products.ts</files>
  <action>
    Add search and complex queries to `convex/products.ts`:
    - `search`: Use `searchIndex("search_en")` and `searchIndex("search_he")` to provide fast full-text search.
    - `getRelated`: Fetch products in the same category, excluding the current product.
    - `validateStock`: Query to check availability of a list of products (essential for checkout).
  </action>
  <verify>Run search queries with Hebrew and English terms and compare results.</verify>
  <done>Hebrew search is significantly faster than previous client-side filtering.</done>
</task>

</tasks>

<verification>
Ensure products are correctly searchable and filterable. Verify that categories correctly group products.
</verification>

<success_criteria>
Bilingual search is functional. Products can be filtered and listed correctly for both Storefront and Admin.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-functions/02-02-SUMMARY.md`
</output>
